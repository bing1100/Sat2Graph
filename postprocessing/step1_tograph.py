import sys 
from subprocess import Popen 
import os  
from time import time, sleep 

# ['4258712_2019-08-08_RE1_3A', '4458610_2018-07-07_RE2_3A', '4458610_2018-08-04_RE1_3A', '4559607_2019-10-30_RE3_3A', '4258619_2018-08-06_RE1_3A', '4359613_2019-07-23_RE3_3A', '4559216_2019-10-31_RE4_3A', '4460008_2018-08-26_RE4_3A',
#  '4359118_2019-07-05_RE3_3A', '4359423_2018-07-07_RE1_3A', '4459815_2018-07-07_RE2_3A', '4559325_2019-08-24_RE3_3A', '4458109_2018-08-04_RE1_3A', '4558513_2018-04-04_RE4_3A', '4459124_2019-07-06_RE1_3A', '4358815_2019-07-11_RE3_3A',
#  '4459206_2019-07-11_RE4_3A', '4558921_2019-07-12_RE2_3A', '4459411_2018-08-06_RE3_3A', '4559520_2018-05-25_RE3_3A', '4359118_2019-10-20_RE4_3A', '4258013_2018-06-26_RE3_3A', '4559708_2019-10-14_RE2_3A', '4458610_2019-07-03_RE2_3A',
#  '4258013_2019-10-13_RE3_3A', '4559614_2018-04-06_RE1_3A', '4659304_2019-07-03_RE4_3A', '4658905_2018-04-06_RE2_3A', '4559708_2019-08-13_RE3_3A', '4658905_2019-07-13_RE3_3A', '4560415_2019-07-19_RE2_3A', '4459206_2018-10-29_RE1_3A',
#  '4459815_2019-10-13_RE1_3A', '4559418_2019-10-20_RE2_3A', '4659204_2019-09-28_RE1_3A', '4360209_2019-08-03_RE2_3A', '4259109_2019-07-05_RE1_3A', '4460219_2019-07-08_RE2_3A', '4659207_2019-08-09_RE1_3A', '4360209_2019-11-01_RE2_3A',
#  '4559321_2019-05-30_RE3_3A', '4560415_2018-04-06_RE1_3A', '4359011_2019-07-23_RE3_3A', '4259514_2018-07-18_RE1_3A', '4359210_2019-05-14_RE4_3A', '4359210_2019-12-12_RE3_3A', '4559418_2018-07-07_RE3_3A', '4460008_2018-05-20_RE1_3A',
#  '4458109_2018-11-26_RE1_3A', '4659304_2019-09-28_RE1_3A', '4459906_2018-10-29_RE1_3A', '4459105_2019-07-11_RE4_3A', '4460120_2018-07-08_RE3_3A', '4359423_2019-10-06_RE4_3A', '4459623_2018-07-01_RE1_3A', '4458610_2019-04-13_RE5_3A',
#  '4359522_2018-10-03_RE4_3A', '4459906_2018-08-26_RE4_3A', '4259215_2019-10-19_RE2_3A', '4259215_2019-07-06_RE2_3A', '4559321_2019-08-03_RE1_3A', '4359620_2018-08-22_RE4_3A', '4459305_2019-05-08_RE4_3A', '4460523_2019-07-12_RE1_3A',
#  '4659207_2019-05-15_RE4_3A', '4559422_2018-07-14_RE1_3A', '4357924_2018-09-03_RE2_3A', '4460621_2018-07-11_RE1_3A', '4560208_2019-06-26_RE2_3A', '4359517_2018-06-29_RE2_3A', '4359222_2018-08-14_RE1_3A', '4359517_2019-10-22_RE1_3A',
#  '4560208_2018-09-19_RE1_3A', '4559216_2018-07-20_RE2_3A', '4559418_2019-05-15_RE3_3A', '4258619_2019-07-13_RE4_3A', '4359222_2018-07-07_RE1_3A', '4459305_2018-10-29_RE1_3A', '4559216_2019-07-17_RE1_3A', '4559325_2019-09-28_RE1_3A',
#  '4460120_2019-10-10_RE3_3A', '4359011_2018-04-21_RE4_3A', '4359613_2019-10-13_RE4_3A', '4558412_2018-07-08_RE4_3A', '4659207_2018-09-30_RE3_3A', '4459124_2018-10-09_RE1_3A', '4258316_2019-06-24_RE2_3A', '4259109_2019-11-01_RE1_3A',
#  '4358815_2018-08-27_RE4_3A', '4460523_2018-04-21_RE1_3A', '4258013_2019-08-10_RE2_3A', '4558921_2018-07-14_RE1_3A', '4259215_2019-07-16_RE1_3A', '4558921_2018-11-24_RE1_3A', '4358808_2018-07-22_RE1_3A', '4258316_2018-10-04_RE3_3A',
#  '4359222_2019-11-13_RE1_3A', '4359011_2018-09-14_RE3_3A', '4559713_2019-06-17_RE4_3A', '4459907_2019-07-11_RE4_3A', '4558513_2019-07-01_RE2_3A', '4460219_2019-10-10_RE3_3A', '4259109_2018-07-04_RE1_3A', '4359210_2018-08-17_RE3_3A',
#  '4358815_2019-12-08_RE2_3A', '4460621_2018-09-10_RE1_3A', '4558911_2019-08-14_RE4_3A', '4558513_2019-10-31_RE4_3A', '4459906_2019-07-06_RE4_3A', '4258716_2019-08-05_RE3_3A', '4559708_2018-06-27_RE2_3A', '4559422_2018-07-02_RE3_3A', '4559607_2019-08-13_RE3_3A', '4359613_2018-08-10_RE1_3A', '4459907_2018-10-29_RE1_3A', '4559607_2019-06-26_RE2_3A', '4560208_2019-08-13_RE3_3A', '4357924_2019-09-01_RE2_3A', '4658905_2018-07-10_RE2_3A', '4559614_2019-10-19_RE1_3A', '4359423_2019-11-13_RE1_3A', '4359118_2018-08-20_RE2_3A', '4558412_2018-10-06_RE4_3A', '4359522_2019-10-06_RE4_3A', '4258716_2018-10-04_RE3_3A', '4359517_2018-07-20_RE4_3A', '4359620_2019-10-10_RE2_3A', '4558911_2018-09-01_RE2_3A', '4559520_2018-04-12_RE3_3A', '4259514_2018-07-20_RE3_3A', '4459105_2018-07-21_RE1_3A', '4258619_2019-10-26_RE2_3A', '4359620_2019-07-18_RE4_3A', '4258316_2019-08-05_RE3_3A', '4459206_2018-07-21_RE1_3A', '4559713_2019-07-11_RE1_3A', '4559325_2019-07-03_RE4_3A', '4460621_2019-07-08_RE2_3A', '4459124_2018-08-20_RE4_3A', '4459411_2019-07-08_RE1_3A', '4259514_2019-10-11_RE2_3A', '4459411_2019-11-01_RE3_3A', '4659204_2019-08-24_RE3_3A', '4358808_2018-09-05_RE3_3A', '4460008_2018-10-29_RE1_3A', '4659204_2019-07-03_RE4_3A', '4459623_2019-08-18_RE2_3A', '4460219_2018-08-01_RE3_3A', '4459907_2018-08-26_RE4_3A', '4458610_2019-07-26_RE2_3A', '4659304_2019-08-24_RE3_3A', '4559713_2019-10-19_RE1_3A', '4359522_2018-09-19_RE4_3A', '4258712_2019-07-06_RE2_3A']
 
in_folder = sys.argv[1]
out_folder = sys.argv[2]

tilenames = []
for file in os.listdir(in_folder):
	items = file.split("_")
	if len(items) < 4:
		continue

	name = items[0]+"_"+items[1]+"_"+items[2]+"_"+items[3]

	if name not in tilenames:
		tilenames.append(name)

print(tilenames)
print(len(tilenames))

# convert segmentation to graph 

pool = []
maxp = 32
cc = 0

for tilename in tilenames:
	print(cc, tilename)
	cmd = ""
	segfile = in_folder + "/" + tilename+ "__segmentation.png"
	classfile = in_folder + "/" + tilename+ "__class.png"
	outputgraph = in_folder + "/" + tilename+ "__seggraph.p"
	outputclass = in_folder + "/" + tilename+ "__segclass.p"
	outputclassvis = in_folder + "/" + tilename+ "__segclassvis.png"
	
	cmd += "python segmentation2graph.py "+segfile+" "+outputgraph+";"
	cmd += "python get_edge_class.py " + outputgraph+" "+classfile+" " + outputclass+";"
	cmd += "python vis_node_graph.py " + outputgraph+" "+outputclass+" " + outputclassvis+""

	while len(pool) > maxp:
		new_pool = []
		for p in pool:
			if p.poll() is None:
				new_pool.append(p)

		pool = new_pool
		sleep(1.0)

	pool.append(Popen(cmd, shell=True))

	cc += 1 

for p in pool:
	p.wait()





